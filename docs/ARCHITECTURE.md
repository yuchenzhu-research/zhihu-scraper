# 🐸 知乎爬虫架构文档

> Last Updated: 2024-02-17

## 📊 项目概览

| 项目 | 信息 |
|------|------|
| **名称** | zhihu-scraper |
| **版本** | v1.0.0 |
| **目标** | 高质量知乎内容离线备份工具 |
| **核心能力** | HTML → Markdown 高保真转换 + LaTeX 公式渲染 |

---

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户层 (User Layer)                          │
├─────────────────────────────────────────────────────────────────────┤
│  交互式界面                    │         CLI 命令行                    │
│  (main.py + questionary)       │         (cli/app.py + Typer)        │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     业务编排层 (Orchestration)                        │
├─────────────────────────────────────────────────────────────────────┤
│                              Pipeline                                │
│         URL 解析 → 抓取调度 → 内容转换 → 图片下载 → 导出              │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      核心服务层 (Core Services)                       │
├─────────────────────────────────────────────────────────────────────┤
│    ZhihuDownloader              │          ZhihuConverter            │
│    (爬虫引擎)                    │          (格式转换器)               │
│    ├── 浏览器自动化              │          ├── HTML 清洗             │
│    ├── 反爬对抗                  │          ├── LaTeX 公式保护         │
│    ├── 内容提取                  │          ├── Markdown 转换         │
│    └── 图片下载 (并发)           │          └── 图片路径重写           │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       基础设施层 (Infrastructure)                     │
├─────────────────────────────────────────────────────────────────────┤
│  config.py          │  errors.py         │  日志系统                   │
│  (配置管理)          │  (异常体系)         │  (structlog)              │
└────────────────────────────────┴────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         外部依赖 (External)                          │
├─────────────────────────────────────────────────────────────────────┤
│  Playwright │  httpx  │  markdownify  │  BeautifulSoup  │  Rich     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📁 目录结构

```
zhihu-scraper/
├── main.py                    🚀 启动入口 (交互式 CLI)
├── cli/                       ✨ 命令行模块 (Typer)
│   ├── __init__.py
│   └── app.py                 # Typer CLI 定义
├── core/                      🧠 核心逻辑
│   ├── __init__.py
│   ├── scraper.py             # 爬虫引擎 + 图片下载
│   ├── converter.py           # HTML → Markdown
│   ├── config.py              # 配置管理 + 日志
│   └── errors.py              # 异常体系
├── static/                    🧶 静态资源
│   ├── stealth.min.js         # 反检测 JS
│   └── z_core.js              # 知乎签名算法
├── cookies.json               🍪 用户凭证
├── config.yaml                ⚙️ 配置文件
├── pyproject.toml             📦 依赖管理
├── README.md                  📖 文档
└── data/                      💾 输出目录
    └── [日期] 问题标题/
        ├── index.md
        └── images/
```

---

## 🔄 数据流

### 抓取流程

```
URL 输入
    │
    ▼
┌─────────────┐
│ URL 解析     │  识别类型 (question/article/answer)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 浏览器初始化  │  headless + stealth + cookies
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 页面加载     │  Playwright goto + wait
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 反爬检测     │  检测 40362 / 验证码
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 内容提取     │  CSS 选择器定位
└──────┬──────┘
       │
       ▼ (多个回答循环)
    ┌──┴──┐
    │     │
    ▼     ▼
┌───────┐ ┌───────────────┐
│图片下载│ │ HTML → Markdown│
└───┬───┘ └───────┬───────┘
    │             │
    └──────┬──────┘
           │
           ▼
    ┌──────┴──────┐
    │ 输出文件     │
    │ index.md    │
    │ images/xxx  │
    └─────────────┘
```

---

## 🔧 核心模块详解

### 1. ZhihuDownloader (爬虫引擎)

**职责**:
- 浏览器生命周期管理
- 页面类型检测和内容提取
- 滚动加载和翻页逻辑
- 图片并发下载
- 反爬对抗策略

**关键类方法**:

| 方法 | 功能 |
|------|------|
| `fetch_page()` | 页面抓取主入口 |
| `_extract_question()` | 问题页 (多回答) |
| `_extract_article()` | 专栏文章 |
| `_extract_answer()` | 单个回答 |
| `_scroll_until_count()` | 按数量滚动 |
| `download_images()` | 并发图片下载 |

### 2. ZhihuConverter (格式转换器)

**职责**:
- HTML 清洗 (去除广告/视频)
- LaTeX 公式提取和保护
- Markdown 转换
- 图片路径重写

**转换流程**:
```
HTML → 预处理(清洗+公式占位) → markdownify → 后处理(还原公式) → Markdown
```

### 3. ConfigLoader (配置中心)

**配置来源**:
1. `config.yaml` (主配置)
2. 环境变量覆盖
3. 默认值

**配置项分类**:
- `zhihu`: 知乎相关 (cookies, browser, anti_detection)
- `crawler`: 爬虫行为 (retry, scroll, images)
- `output`: 输出格式
- `logging`: 日志配置

### 4. ErrorHandle (异常体系)

```
ZhihuScraperError (基类)
├── NetworkError           # 网络问题
├── AntiDetectionError     # 反爬触发
├── ContentParseError      # 解析失败
├── ContentNotFoundError   # 内容不存在
├── ConfigError            # 配置错误
├── BrowserError           # 浏览器错误
└── ImageDownloadError     # 图片下载失败
```

---

## 📦 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **浏览器** | Playwright | 自动化 + 反检测 |
| **HTTP** | httpx | 图片异步下载 |
| **HTML解析** | BeautifulSoup4 | DOM 操作 |
| **转换** | markdownify | HTML → Markdown |
| **CLI** | Rich + Typer | 终端 UI |
| **日志** | structlog | 结构化日志 |
| **配置** | PyYAML | YAML 解析 |
| **JS执行** | PyExecJS | 签名算法 |

---

## 🎯 待优化方向

### 短期 (v1.1.0)
- [ ] 完善 CLI 批量并发
- [ ] 重试机制集成到抓取流程
- [ ] 断点��传支持

### 中期 (v1.2.0)
- [ ] 代码质量 (类型注解)
- [ ] 单元测试覆盖
- [ ] HTTP API 服务

### 长期 (v2.0.0)
- [ ] 通用爬虫框架
- [ ] 多平台支持
- [ ] Web UI 管理界面